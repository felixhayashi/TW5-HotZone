/*\

title: $:/plugins/felixhayashi/hotzone/hotzone.js
type: application/javascript
module-type: startup

@preserve

\*/
(function(){"use strict";exports.name="hotzone";exports.platforms=["browser"];exports.after=["story"];exports.synchronous=true;exports.startup=function(){var e=require("$:/plugins/felixhayashi/hotzone/config.js").config;var t=null;var i=false;var r=document.getElementsByClassName(e.classNames.storyRiver)[0];var s=r.getElementsByClassName(e.classNames.tiddlerFrame);var n=$tw.wiki.getTiddlerData(e.references.userConfig,{});var a=isNaN(parseInt(n.focusOffset))?150:parseInt(n.focusOffset);var o=function(t,i,r){if(!(t instanceof Element))return;if(!$tw.utils.hasClass(t,e.classNames.tiddlerFrame))return;var s=t.getElementsByClassName(e.classNames.tiddlerTitle)[0];if(s){var n=s.innerText||s.textContent;return n.trim()}};var l=function(e){if(!i){i=true;window.setTimeout(d,e||0)}};var f=function(t,i){$tw.wiki.addTiddler(new $tw.Tiddler({title:e.references.focussedTiddlerStore,text:t},$tw.wiki.getModificationFields()));if(i){var r=document.getElementsByClassName("hzone-focus")[0];if(r){$tw.utils.removeClass(r,"hzone-focus")}$tw.utils.addClass(i,"hzone-focus")}};var d=function(){if(s.length){var e=42;for(var r=0;r<s.length;r++){if(window.getComputedStyle(s[r])["display"]==="block"){e=s[r].getBoundingClientRect().left;break}}var n=document.elementFromPoint(e+1,a);var l=o(n);if(l!==t&&$tw.wiki.getTiddler(l)){t=l;f(t,n)}}else if(t){t="";f(t)}i=false};var u=function(e){if(e["$:/HistoryList"]){if(!$tw.wiki.tiddlerExists("$:/HistoryList"))return;var t=$tw.wiki.getTiddler("$:/HistoryList").fields["current-tiddler"];var i=$tw.wiki.getTiddlerList("$:/StoryList");var r=i.indexOf(t)>=0;if(!r)return;l($tw.utils.getAnimationDuration()+100)}else if(e["$:/StoryList"]){l($tw.utils.getAnimationDuration()+100)}};var c=function(e){l(250)};$tw.wiki.addEventListener("change",u);window.addEventListener("scroll",c,false);c()}})();